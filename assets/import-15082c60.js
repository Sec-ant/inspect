import{W as S,Y as x,a as E,S as L,P as m,_ as v}from"./storage-bd0a0faa.js";import{i as B,a as j,j as P}from"./file_type-dd3bd1e2.js";const b=(()=>{if(typeof self>"u")return!1;if("top"in self&&self!==top)try{}catch{return!1}return"showOpenFilePicker"in self})(),F=b?Promise.resolve().then(function(){return N}):Promise.resolve().then(function(){return D});async function O(...e){return(await F).default(...e)}b?Promise.resolve().then(function(){return U}):Promise.resolve().then(function(){return H});b?Promise.resolve().then(function(){return $}):Promise.resolve().then(function(){return q});const T=async e=>{const r=await e.getFile();return r.handle=e,r};var I=async(e=[{}])=>{Array.isArray(e)||(e=[e]);const r=[];e.forEach((i,s)=>{r[s]={description:i.description||"Files",accept:{}},i.mimeTypes?i.mimeTypes.map(o=>{r[s].accept[o]=i.extensions||[]}):r[s].accept["*/*"]=i.extensions||[]});const n=await window.showOpenFilePicker({id:e[0].id,startIn:e[0].startIn,types:r,multiple:e[0].multiple||!1,excludeAcceptAllOption:e[0].excludeAcceptAllOption||!1}),t=await Promise.all(n.map(T));return e[0].multiple?t:t[0]},N={__proto__:null,default:I};function w(e){function r(n){if(Object(n)!==n)return Promise.reject(new TypeError(n+" is not an object."));var t=n.done;return Promise.resolve(n.value).then(function(i){return{value:i,done:t}})}return w=function(n){this.s=n,this.n=n.next},w.prototype={s:null,n:null,next:function(){return r(this.n.apply(this.s,arguments))},return:function(n){var t=this.s.return;return t===void 0?Promise.resolve({value:n,done:!0}):r(t.apply(this.s,arguments))},throw:function(n){var t=this.s.return;return t===void 0?Promise.reject(n):r(t.apply(this.s,arguments))}},new w(e)}const k=async(e,r,n=e.name,t)=>{const i=[],s=[];var o,c=!1,l=!1;try{for(var u,a=function(p){var d,f,y,g=2;for(typeof Symbol<"u"&&(f=Symbol.asyncIterator,y=Symbol.iterator);g--;){if(f&&(d=p[f])!=null)return d.call(p);if(y&&(d=p[y])!=null)return new w(d.call(p));f="@@asyncIterator",y="@@iterator"}throw new TypeError("Object is not async iterable")}(e.values());c=!(u=await a.next()).done;c=!1){const p=u.value,d=`${n}/${p.name}`;p.kind==="file"?s.push(p.getFile().then(f=>(f.directoryHandle=e,f.handle=p,Object.defineProperty(f,"webkitRelativePath",{configurable:!0,enumerable:!0,get:()=>d})))):p.kind!=="directory"||!r||t&&t(p)||i.push(k(p,r,d,t))}}catch(p){l=!0,o=p}finally{try{c&&a.return!=null&&await a.return()}finally{if(l)throw o}}return[...(await Promise.all(i)).flat(),...await Promise.all(s)]};var R=async(e={})=>{e.recursive=e.recursive||!1,e.mode=e.mode||"read";const r=await window.showDirectoryPicker({id:e.id,startIn:e.startIn,mode:e.mode});return(await(await r.values()).next()).done?[r]:k(r,e.recursive,void 0,e.skipDirectory)},U={__proto__:null,default:R},W=async(e,r=[{}],n=null,t=!1,i=null)=>{Array.isArray(r)||(r=[r]),r[0].fileName=r[0].fileName||"Untitled";const s=[];let o=null;if(e instanceof Blob&&e.type?o=e.type:e.headers&&e.headers.get("content-type")&&(o=e.headers.get("content-type")),r.forEach((u,a)=>{s[a]={description:u.description||"Files",accept:{}},u.mimeTypes?(a===0&&o&&u.mimeTypes.push(o),u.mimeTypes.map(p=>{s[a].accept[p]=u.extensions||[]})):o?s[a].accept[o]=u.extensions||[]:s[a].accept["*/*"]=u.extensions||[]}),n)try{await n.getFile()}catch(u){if(n=null,t)throw u}const c=n||await window.showSaveFilePicker({suggestedName:r[0].fileName,id:r[0].id,startIn:r[0].startIn,types:s,excludeAcceptAllOption:r[0].excludeAcceptAllOption||!1});!n&&i&&i(c);const l=await c.createWritable();return"stream"in e?(await e.stream().pipeTo(l),c):"body"in e?(await e.body.pipeTo(l),c):(await l.write(await e),await l.close(),c)},$={__proto__:null,default:W},z=async(e=[{}])=>(Array.isArray(e)||(e=[e]),new Promise((r,n)=>{const t=document.createElement("input");t.type="file";const i=[...e.map(l=>l.mimeTypes||[]),...e.map(l=>l.extensions||[])].join();t.multiple=e[0].multiple||!1,t.accept=i||"",t.style.display="none",document.body.append(t);const s=l=>{typeof o=="function"&&o(),r(l)},o=e[0].legacySetup&&e[0].legacySetup(s,()=>o(n),t),c=()=>{window.removeEventListener("focus",c),t.remove()};t.addEventListener("click",()=>{window.addEventListener("focus",c)}),t.addEventListener("change",()=>{window.removeEventListener("focus",c),t.remove(),s(t.multiple?Array.from(t.files):t.files[0])}),"showPicker"in HTMLInputElement.prototype?t.showPicker():t.click()})),D={__proto__:null,default:z},J=async(e=[{}])=>(Array.isArray(e)||(e=[e]),e[0].recursive=e[0].recursive||!1,new Promise((r,n)=>{const t=document.createElement("input");t.type="file",t.webkitdirectory=!0;const i=o=>{typeof s=="function"&&s(),r(o)},s=e[0].legacySetup&&e[0].legacySetup(i,()=>s(n),t);t.addEventListener("change",()=>{let o=Array.from(t.files);e[0].recursive?e[0].recursive&&e[0].skipDirectory&&(o=o.filter(c=>c.webkitRelativePath.split("/").every(l=>!e[0].skipDirectory({name:l,kind:"directory"})))):o=o.filter(c=>c.webkitRelativePath.split("/").length===2),i(o)}),"showPicker"in HTMLInputElement.prototype?t.showPicker():t.click()})),H={__proto__:null,default:J},M=async(e,r={})=>{Array.isArray(r)&&(r=r[0]);const n=document.createElement("a");let t=e;"body"in e&&(t=await async function(o,c){const l=o.getReader(),u=new ReadableStream({start:d=>async function f(){return l.read().then(({done:y,value:g})=>{if(!y)return d.enqueue(g),f();d.close()})}()}),a=new Response(u),p=await a.blob();return l.releaseLock(),new Blob([p],{type:c})}(e.body,e.headers.get("content-type"))),n.download=r.fileName||"Untitled",n.href=URL.createObjectURL(await t);const i=()=>{typeof s=="function"&&s()},s=r.legacySetup&&r.legacySetup(i,()=>s(),n);return n.addEventListener("click",()=>{setTimeout(()=>URL.revokeObjectURL(n.href),3e4),i()}),n.click(),null},q={__proto__:null,default:M};function A(e,r,n){const t=new Uint8Array(e),i=new Uint8Array(r),s=i.length,o=[];let c=0,l=-1,u=0;for(let a=0;a<t.length;a++)if(t[a]===i[0]){l=0;for(let p=1;p<s;p++)if(t[a+p]!==i[p]){l=-1;break}if(l===0){const p=e.slice(c,a);if(o.push(p),c=a+s,a+=s-1,u++,n&&u===Math.abs(n))break}}if(c<t.length){const a=e.slice(c);o.push(a)}return o}const h=new Uint8Array([0,0,0,0,73,69,78,68,174,66,96,130]).buffer,_=new TextDecoder,Z=async()=>{const e=await O({multiple:!0,mimeTypes:["image/png","application/zip"]}),r=e.filter(i=>i.name.endsWith(".zip")),n=e.filter(i=>i.name.endsWith(".png"));if(r.length==0&&n.length==0){m.warning("没有发现可导入文件");return}let t=0;r.length>0&&await Promise.any(r.map(async i=>{const s=await P.loadAsync(i),o=s.filter(a=>a.endsWith(".json"))[0],c=s.filter(a=>a.endsWith(".png"))[0];if(!o||!c)return;const l=JSON.parse(await o.async("string")),u=await c.async("arraybuffer");await v(l,u),t++})),n.length>0&&await Promise.any(n.map(async i=>{const s=await i.arrayBuffer(),[o,c]=A(s,h,2);if(!c)return;const l=await new Blob([o,h]).arrayBuffer(),u=JSON.parse(_.decode(c));await v(u,l),t++})),t>0?m.success(`导入${t}条记录`):m.warning("没有发现可导入记录")},C=async(e=[])=>{if(typeof e=="string"&&(e=[e]),e.length==0)return;e=[...new Set(e)];const r=S(2);let n=0;const t=await Promise.allSettled(e.map(i=>r(async()=>{const s=x[i];if(s){const a=await E.getItem(s);if(a)return n++,a}const c=await(await L(i).catch(a=>{throw m.error(`网络异常: ${new URL(i).host}/${a.message||""}`),console.warn(["download failed",i,a]),a})).arrayBuffer();let l,u;if(B(c)){const[a,p]=A(c,h,2);if(!p)return;u=await new Blob([a,h]).arrayBuffer(),l=JSON.parse(_.decode(p))}else if(j(c)){const a=await P.loadAsync(c),[p]=a.filter(f=>f.endsWith(".json")),[d]=a.filter(f=>f.endsWith(".png"));if(!p||!d)return;u=await d.async("arraybuffer"),l=JSON.parse(await p.async("string"))}else throw new Error("file must be png or zip");return await v(l,u),n++,l})));return n==0?m.warning("没有发现可导入记录"):n==e.length?m.success(`导入${n}条快照`):n<e.length&&m.success(`导入${n}条快照，失败${e.length-n}`),t};export{C as a,Z as i};
//# sourceMappingURL=import-15082c60.js.map
