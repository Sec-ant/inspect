import{s as V,u as m,v as de,O as re,P as me,n as L,Q as ve,S as he,b as I,D as ye,c as we,U as ge,C as ae,d as _e,N as Se,w as Oe,a as be,V as Pe,e as K,f as g,g as C,j as N,o as X,W as Ce,i as $e,F as Re,h as ke,t as Ne,k as je}from"./index-306318ac.js";import{S as Ee,P as $,R as Ie,a as A,Q as j,W as xe,b as E}from"./storage-1bb32d90.js";import{t as Ae}from"./check-44032eaf.js";import{a as Fe}from"./error-bd8f55ae.js";import{u as De,N as Ve}from"./table-e06afa85.js";import{u as U,p as ze,c as H,a as We,N as Le}from"./task-790a6956.js";const Me=e=>{const t=V(e),n=async(o,f={})=>{if(!t.value)throw new Error("origin must exist");const c=new URL("/api/"+o,t.value);Object.entries(f).forEach(([p,y])=>{y!==void 0&&c.searchParams.set(p,String(y))});const u=await Ee(c).catch(p=>{throw $.error("网络错误:/"+o),p});if(!u.ok)throw $.error("接口错误:/"+o+":"+u.status),u;if(u.headers.get("X_Rpc_Result")!="ok"){const p=await u.json();throw $.error(p.message),u}return u},r=async(...o)=>await(await n(...o)).json(),s=async(...o)=>await(await n(...o)).arrayBuffer();return{origin:t,api:{device:async()=>r("device"),snapshot:async o=>r("snapshot",o),screenshot:async o=>s("screenshot",o),captureSnapshot:async()=>r("captureSnapshot"),snapshots:async()=>r("snapshots")}}};function se(e){return ve()?(he(e),!0):!1}function M(e){return typeof e=="function"?e():m(e)}const oe=typeof window<"u",ie=()=>{};function Te(e,t){function n(...r){return new Promise((s,l)=>{Promise.resolve(e(()=>t.apply(this,r),{fn:t,thisArg:this,args:r})).then(s).catch(l)})}return n}const le=e=>e();function Be(e=le){const t=L(!0);function n(){t.value=!1}function r(){t.value=!0}const s=(...l)=>{t.value&&e(...l)};return{isActive:re(t),pause:n,resume:r,eventFilter:s}}function Ue(...e){if(e.length!==1)return de(...e);const t=e[0];return typeof t=="function"?re(me(()=>({get:t,set:ie}))):L(t)}var Q=Object.getOwnPropertySymbols,Je=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable,Xe=(e,t)=>{var n={};for(var r in e)Je.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&Q)for(var r of Q(e))t.indexOf(r)<0&&Ke.call(e,r)&&(n[r]=e[r]);return n};function He(e,t,n={}){const r=n,{eventFilter:s=le}=r,l=Xe(r,["eventFilter"]);return I(e,Te(s,t),l)}var Qe=Object.defineProperty,qe=Object.defineProperties,Ge=Object.getOwnPropertyDescriptors,z=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,q=(e,t,n)=>t in e?Qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Ye=(e,t)=>{for(var n in t||(t={}))ue.call(t,n)&&q(e,n,t[n]);if(z)for(var n of z(t))ce.call(t,n)&&q(e,n,t[n]);return e},Ze=(e,t)=>qe(e,Ge(t)),et=(e,t)=>{var n={};for(var r in e)ue.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&z)for(var r of z(e))t.indexOf(r)<0&&ce.call(e,r)&&(n[r]=e[r]);return n};function tt(e,t,n={}){const r=n,{eventFilter:s}=r,l=et(r,["eventFilter"]),{eventFilter:o,pause:f,resume:c,isActive:u}=Be(s);return{stop:He(e,t,Ze(Ye({},l),{eventFilter:o})),pause:f,resume:c,isActive:u}}function pe(e){var t;const n=M(e);return(t=n==null?void 0:n.$el)!=null?t:n}const W=oe?window:void 0,nt=oe?window.document:void 0;function G(...e){let t,n,r,s;if(typeof e[0]=="string"||Array.isArray(e[0])?([n,r,s]=e,t=W):[t,n,r,s]=e,!t)return ie;Array.isArray(n)||(n=[n]),Array.isArray(r)||(r=[r]);const l=[],o=()=>{l.forEach(v=>v()),l.length=0},f=(v,p,y,_)=>(v.addEventListener(p,y,_),()=>v.removeEventListener(p,y,_)),c=I(()=>[pe(t),M(s)],([v,p])=>{o(),v&&l.push(...n.flatMap(y=>r.map(_=>f(v,y,_,p))))},{immediate:!0,flush:"post"}),u=()=>{c(),o()};return se(u),u}function rt(){const e=L(!1);return ge()&&ae(()=>{e.value=!0}),e}function at(e){const t=rt();return we(()=>(t.value,!!e()))}const F=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},D="__vueuse_ssr_handlers__",st=ot();function ot(){return D in F||(F[D]=F[D]||{}),F[D]}function it(e,t){return st[e]||t}function lt(e){return e==null?"any":e instanceof Set?"set":e instanceof Map?"map":e instanceof Date?"date":typeof e=="boolean"?"boolean":typeof e=="string"?"string":typeof e=="object"?"object":Number.isNaN(e)?"any":"number"}var ut=Object.defineProperty,Y=Object.getOwnPropertySymbols,ct=Object.prototype.hasOwnProperty,pt=Object.prototype.propertyIsEnumerable,Z=(e,t,n)=>t in e?ut(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ee=(e,t)=>{for(var n in t||(t={}))ct.call(t,n)&&Z(e,n,t[n]);if(Y)for(var n of Y(t))pt.call(t,n)&&Z(e,n,t[n]);return e};const ft={boolean:{read:e=>e==="true",write:e=>String(e)},object:{read:e=>JSON.parse(e),write:e=>JSON.stringify(e)},number:{read:e=>Number.parseFloat(e),write:e=>String(e)},any:{read:e=>e,write:e=>String(e)},string:{read:e=>e,write:e=>String(e)},map:{read:e=>new Map(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e.entries()))},set:{read:e=>new Set(JSON.parse(e)),write:e=>JSON.stringify(Array.from(e))},date:{read:e=>new Date(e),write:e=>e.toISOString()}},te="vueuse-storage";function dt(e,t,n,r={}){var s;const{flush:l="pre",deep:o=!0,listenToStorageChanges:f=!0,writeDefaults:c=!0,mergeDefaults:u=!1,shallow:v,window:p=W,eventFilter:y,onError:_=a=>{console.error(a)}}=r,S=(v?V:L)(t);if(!n)try{n=it("getDefaultStorage",()=>{var a;return(a=W)==null?void 0:a.localStorage})()}catch(a){_(a)}if(!n)return S;const b=M(t),x=lt(b),R=(s=r.serializer)!=null?s:ft[x],{pause:T,resume:k}=tt(S,()=>B(S.value),{flush:l,deep:o,eventFilter:y});return p&&f&&(G(p,"storage",h),G(p,te,i)),h(),S;function B(a){try{if(a==null)n.removeItem(e);else{const d=R.write(a),w=n.getItem(e);w!==d&&(n.setItem(e,d),p&&p.dispatchEvent(new CustomEvent(te,{detail:{key:e,oldValue:w,newValue:d,storageArea:n}})))}}catch(d){_(d)}}function P(a){const d=a?a.newValue:n.getItem(e);if(d==null)return c&&b!==null&&n.setItem(e,R.write(b)),b;if(!a&&u){const w=R.read(d);return typeof u=="function"?u(w,b):x==="object"&&!Array.isArray(w)?ee(ee({},b),w):w}else return typeof d!="string"?d:R.read(d)}function i(a){h(a.detail)}function h(a){if(!(a&&a.storageArea!==n)){if(a&&a.key==null){S.value=b;return}if(!(a&&a.key!==e)){T();try{S.value=P(a)}catch(d){_(d)}finally{a?ye(k):k()}}}}}var ne=Object.getOwnPropertySymbols,mt=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable,ht=(e,t)=>{var n={};for(var r in e)mt.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&ne)for(var r of ne(e))t.indexOf(r)<0&&vt.call(e,r)&&(n[r]=e[r]);return n};function yt(e,t,n={}){const r=n,{window:s=W}=r,l=ht(r,["window"]);let o;const f=at(()=>s&&"MutationObserver"in s),c=()=>{o&&(o.disconnect(),o=void 0)},u=I(()=>pe(e),p=>{c(),f.value&&s&&p&&(o=new MutationObserver(t),o.observe(p,l))},{immediate:!0}),v=()=>{c(),u()};return se(v),{isSupported:f,stop:v}}function wt(e=null,t={}){var n,r;const{document:s=nt}=t,l=Ue((n=e??(s==null?void 0:s.title))!=null?n:null),o=e&&typeof e=="function";function f(c){if(!("titleTemplate"in t))return c;const u=t.titleTemplate||"%s";return typeof u=="function"?u(c):M(u).replace(/%s/g,c)}return I(l,(c,u)=>{c!==u&&s&&(s.title=f(typeof c=="string"?c:""))},{immediate:!0}),t.observe&&!t.titleTemplate&&s&&!o&&yt((r=s.head)==null?void 0:r.querySelector("title"),()=>{s&&s.title!==l.value&&(l.value=f(s.title))},{childList:!0}),l}const gt={flex:"","flex-col":"","p-10px":"","gap-10px":"","h-full":""},_t={class:"h-full",flex:"","flex-items-center":""},Rt=_e({__name:"DevicePage",setup(e){const t=Se(),n=wt("新设备"),{api:r,origin:s}=Me(),l=dt("device_link",""),o=V(),f=U(async()=>{l.value&&(s.value=Fe(()=>new URL(l.value.trim()),()=>"非法设备地址").origin,l.value=s.value,o.value=await r.device())});ae(async()=>{await Ie(500),Ae(l.value)&&f.invoke()});const c=V([]);Oe(async()=>{if(!o.value)return;n.value="已连接 "+o.value.manufacturer;const i=await r.snapshots();i.sort((h,a)=>a.id-h.id),c.value=i});const u=U(async()=>{const i=await r.snapshot(),h=await r.screenshot({id:i.id});$.success("抓取快照成功"),await A.setItem(i.id,i),await j.setItem(i.id,h),$.success("保存快照成功");const a=await r.snapshots();a.sort((d,w)=>w.id-d.id),c.value=a}),v=U(async()=>{const i=(await r.snapshots()).map(O=>O.id),h=new Set((await j.keys()).map(O=>parseInt(O))),a=i.filter(O=>!h.has(O));if(a.length==0){$.success("没有新记录可导入");return}let d=0;const w=xe(3);await Promise.all(a.map(O=>w(async()=>{const[J,fe]=await Promise.all([r.snapshot({id:O}),r.screenshot({id:O})]);J.nodes&&(await Promise.all([A.setItem(O,J),j.setItem(O,fe)]),d++)}))),$.success(`导入${d}条新记录`)}),{activityIdCol:p,appIdCol:y,appNameCol:_,ctimeCol:S,appVersionCodeCol:b,appVersionNameCol:x,reseColWidth:R}=De(),T=i=>{i.columnKey==S.key&&(S.sortOrder=i.order)},k=ze(async i=>{if(await A.hasItem(i.id)||await A.setItem(i.id,await r.snapshot({id:i.id})),!await j.hasItem(i.id)){const h=await r.screenshot({id:i.id});await j.setItem(i.id,h)}window.open(t.resolve({name:"snapshot",params:{snapshotId:i.id}}).href)},i=>i.id),B=[S,_,y,b,x,p,{key:"actions",title:"Action",fixed:"right",width:"120px",render(i){return g(H,{size:"small"},{default:()=>[g(E,{size:"small",loading:k.loading[i.id],onClick:()=>k.invoke(i)},{default:()=>[N("查看")]})]})}}],P=be({page:1,pageSize:50,showSizePicker:!0,pageSizes:[50,100],onChange:i=>{P.page=i},onUpdatePageSize:i=>{P.pageSize=i,P.page=1}});return I(P,R),(i,h)=>{const a=Pe("RouterLink");return X(),K("div",gt,[g(m(H),null,{default:C(()=>[g(a,{to:"/"},{default:C(()=>[g(m(E),null,{default:C(()=>[N(" 首页 ")]),_:1})]),_:1}),g(m(We),null,{default:C(()=>[g(m(Le),{value:m(l),"onUpdate:value":h[0]||(h[0]=d=>Ce(l)?l.value=d:null),placeholder:"请输入设备地址",style:{minWidth:"250px"},onKeyup:$e(m(f).invoke,["enter"])},null,8,["value","onKeyup"]),g(m(E),{ghost:"",onClick:m(f).invoke,loading:m(f).loading},{default:C(()=>[N(" 连接 ")]),_:1},8,["onClick","loading"])]),_:1}),o.value?(X(),K(Re,{key:0},[ke("div",_t,Ne(`已连接 ${o.value.manufacturer} Android ${o.value.release}`),1),g(m(E),{ghost:"",onClick:m(u).invoke,loading:m(u).loading},{default:C(()=>[N(" 快照 ")]),_:1},8,["onClick","loading"]),g(m(E),{ghost:"",onClick:m(v).invoke,loading:m(v).loading},{default:C(()=>[N(" 下载设备所有快照 ")]),_:1},8,["onClick","loading"])],64)):je("",!0)]),_:1}),g(m(Ve),{striped:"",flexHeight:"",data:c.value,columns:B,pagination:m(P),"onUpdate:sorter":T,size:"small",class:"flex-1",scrollX:1200},null,8,["data","pagination"])])}}});export{Rt as default};
//# sourceMappingURL=DevicePage-0584feb3.js.map
