import{s as V,aq as h,d as $,as as H,aa as O,w as q,a as G,e as X,av as J,f as T,b as n,g as d,u as s,m as y,n as x,o as U,N as Q,aw as Y,l as Z,F as ee,h as L,t as ae,p as se}from"./index-89bd64bf.js";import{h as te,f as ne,a as I,e as k,p as oe}from"./storage-b53c4e07.js";import{t as ie}from"./check-44032eaf.js";import{u as re,b as le,a as ce}from"./index-a4d11815.js";import{u as ue,N as pe}from"./table-5a687230.js";import{u as R,o as de,b as j,c as he,N as me}from"./task-b0835956.js";const fe=B=>{const w=V(B),_=async(a,u={})=>{var g;if(!w.value)throw new Error("origin must exist");const m=new URL("/api/"+a,w.value);Object.entries(u).forEach(([p,S])=>{S!==void 0&&m.searchParams.set(p,String(S))});const o=await te(m).catch(p=>{throw h.error("网络错误:/"+a),p});if(!o.ok)throw h.error("接口错误:/"+a+":"+o.status),o;if((g=o.headers.get("Content-Type"))!=null&&g.includes("application/json")){const p=await o.clone().json();if(p.__error)throw h.error(p.message),o}return o},t=async(...a)=>await(await _(...a)).json(),C=async(...a)=>await(await _(...a)).arrayBuffer();return{origin:w,api:{device:async()=>t("device"),snapshot:async a=>t("snapshot",a),screenshot:async a=>C("screenshot",a),captureSnapshot:async()=>t("captureSnapshot"),snapshots:async()=>t("snapshots")}}},we={flex:"","flex-col":"","p-10px":"","gap-10px":"","h-full":""},ge=L("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 32 32"},[L("path",{d:"M16.612 2.214a1.01 1.01 0 0 0-1.242 0L1 13.419l1.243 1.572L4 13.621V26a2.004 2.004 0 0 0 2 2h20a2.004 2.004 0 0 0 2-2V13.63L29.757 15L31 13.428zM18 26h-4v-8h4zm2 0v-8a2.002 2.002 0 0 0-2-2h-4a2.002 2.002 0 0 0-2 2v8H6V12.062l10-7.79l10 7.8V26z",fill:"currentColor"})],-1),ve={class:"h-full",flex:"","flex-items-center":""},Ie=$({__name:"DevicePage",setup(B){const w=H(),_=re("新设备"),{api:t,origin:C}=fe(),c=le("device_link",""),a=V(),u=R(async()=>{c.value&&(C.value=ce(()=>new URL(c.value.trim()),()=>"非法设备地址").origin,c.value=C.value,a.value=await t.device())});O(async()=>{await ne(500),ie(c.value)&&u.invoke()});const m=V([]);q(async()=>{if(!a.value)return;_.value="已连接 "+a.value.manufacturer;const e=await t.snapshots();e.sort((i,l)=>l.id-i.id),m.value=e});const o=R(async()=>{const e=await t.captureSnapshot(),i=await t.screenshot({id:e.id});h.success("抓取快照成功"),await I.setItem(e.id,e),await k.setItem(e.id,i),h.success("保存快照成功");const l=await t.snapshots();l.sort((f,z)=>z.id-f.id),m.value=l}),g=R(async()=>{const e=(await t.snapshots()).map(r=>r.id),i=new Set((await k.keys()).map(r=>parseInt(r))),l=e.filter(r=>!i.has(r));if(l.length==0){h.success("没有新记录可导入");return}let f=0;const z=oe(3);await Promise.all(l.map(r=>z(async()=>{const[b,W]=await Promise.all([t.snapshot({id:r}),t.screenshot({id:r})]);b.nodes&&(await Promise.all([I.setItem(r,b),k.setItem(r,W)]),f++)}))),h.success(`导入${f}条新记录`)}),{activityIdCol:p,appIdCol:S,appNameCol:E,ctimeCol:N,appVersionCodeCol:A,appVersionNameCol:D,reseColWidth:K}=ue(),F=e=>{e.columnKey==N.key&&(N.sortOrder=e.order)},P=de(async e=>{if(await I.hasItem(e.id)||await I.setItem(e.id,await t.snapshot({id:e.id})),!await k.hasItem(e.id)){const i=await t.screenshot({id:e.id});await k.setItem(e.id,i)}window.open(w.resolve({name:"snapshot",params:{snapshotId:e.id}}).href)},e=>e.id),M=[N,E,S,A,D,p,{key:"actions",title:"Action",fixed:"right",width:"120px",render(e){return n(j,{size:"small"},{default:()=>[n(y,{size:"small",loading:P.loading[e.id],onClick:()=>P.invoke(e)},{default:()=>[x("查看")]})]})}}],v=G({page:1,pageSize:50,showSizePicker:!0,pageSizes:[50,100],onChange:e=>{v.page=e},onUpdatePageSize:e=>{v.pageSize=e,v.page=1}});return X(v,K),(e,i)=>{const l=J("RouterLink");return U(),T("div",we,[n(s(j),null,{default:d(()=>[n(l,{to:"/"},{default:d(()=>[n(s(y),null,{icon:d(()=>[n(s(he),null,{default:d(()=>[ge]),_:1})]),_:1})]),_:1}),n(s(me),null,{default:d(()=>[n(s(Q),{value:s(c),"onUpdate:value":i[0]||(i[0]=f=>Y(c)?c.value=f:null),placeholder:"请输入设备地址",style:{minWidth:"250px"},onKeyup:Z(s(u).invoke,["enter"])},null,8,["value","onKeyup"]),n(s(y),{ghost:"",onClick:s(u).invoke,loading:s(u).loading},{default:d(()=>[x(" 刷新连接 ")]),_:1},8,["onClick","loading"])]),_:1}),a.value?(U(),T(ee,{key:0},[L("div",ve,ae(`已连接 ${a.value.manufacturer} Android ${a.value.release}`),1),n(s(y),{ghost:"",onClick:s(o).invoke,loading:s(o).loading},{default:d(()=>[x(" 快照 ")]),_:1},8,["onClick","loading"]),n(s(y),{ghost:"",onClick:s(g).invoke,loading:s(g).loading},{default:d(()=>[x(" 下载设备所有快照 ")]),_:1},8,["onClick","loading"])],64)):se("",!0)]),_:1}),n(s(pe),{striped:"",flexHeight:"",data:m.value,columns:M,pagination:s(v),"onUpdate:sorter":F,size:"small",class:"flex-1",scrollX:1200},null,8,["data","pagination"])])}}});export{Ie as default};
//# sourceMappingURL=DevicePage-e8736f68.js.map
