import{s as z,d as F,N as O,C as $,w as G,a as H,b as M,O as Q,e as L,f as n,g as d,u as s,j as w,o as U,P as q,i as J,F as Y,h as Z,t as ee,k as ae}from"./index-710f2f9d.js";import{S as se,P as h,R as te,a as R,Q as k,W as ne,b as y}from"./storage-4cf6cc6a.js";import{t as oe}from"./check-44032eaf.js";import{u as ie,b as re,a as le}from"./index-bd871822.js";import{u as ce,N as ue}from"./table-93e8d0f8.js";import{u as P,p as pe,c as j,a as de,N as he}from"./task-250aa9c6.js";const me=B=>{const g=z(B),_=async(a,u={})=>{if(!g.value)throw new Error("origin must exist");const m=new URL("/api/"+a,g.value);Object.entries(u).forEach(([p,C])=>{C!==void 0&&m.searchParams.set(p,String(C))});const o=await se(m).catch(p=>{throw h.error("网络错误:/"+a),p});if(!o.ok)throw h.error("接口错误:/"+a+":"+o.status),o;if(o.headers.get("X_Rpc_Result")!="ok"){const p=await o.json();throw h.error(p.message),o}return o},t=async(...a)=>await(await _(...a)).json(),S=async(...a)=>await(await _(...a)).arrayBuffer();return{origin:g,api:{device:async()=>t("device"),snapshot:async a=>t("snapshot",a),screenshot:async a=>S("screenshot",a),captureSnapshot:async()=>t("captureSnapshot"),snapshots:async()=>t("snapshots")}}},fe={flex:"","flex-col":"","p-10px":"","gap-10px":"","h-full":""},ge={class:"h-full",flex:"","flex-items-center":""},Ce=F({__name:"DevicePage",setup(B){const g=O(),_=ie("新设备"),{api:t,origin:S}=me(),c=re("device_link",""),a=z(),u=P(async()=>{c.value&&(S.value=le(()=>new URL(c.value.trim()),()=>"非法设备地址").origin,c.value=S.value,a.value=await t.device())});$(async()=>{await te(500),oe(c.value)&&u.invoke()});const m=z([]);G(async()=>{if(!a.value)return;_.value="已连接 "+a.value.manufacturer;const e=await t.snapshots();e.sort((i,l)=>l.id-i.id),m.value=e});const o=P(async()=>{const e=await t.snapshot(),i=await t.screenshot({id:e.id});h.success("抓取快照成功"),await R.setItem(e.id,e),await k.setItem(e.id,i),h.success("保存快照成功");const l=await t.snapshots();l.sort((f,N)=>N.id-f.id),m.value=l}),x=P(async()=>{const e=(await t.snapshots()).map(r=>r.id),i=new Set((await k.keys()).map(r=>parseInt(r))),l=e.filter(r=>!i.has(r));if(l.length==0){h.success("没有新记录可导入");return}let f=0;const N=ne(3);await Promise.all(l.map(r=>N(async()=>{const[b,X]=await Promise.all([t.snapshot({id:r}),t.screenshot({id:r})]);b.nodes&&(await Promise.all([R.setItem(r,b),k.setItem(r,X)]),f++)}))),h.success(`导入${f}条新记录`)}),{activityIdCol:p,appIdCol:C,appNameCol:E,ctimeCol:I,appVersionCodeCol:T,appVersionNameCol:A,reseColWidth:D}=ce(),K=e=>{e.columnKey==I.key&&(I.sortOrder=e.order)},V=pe(async e=>{if(await R.hasItem(e.id)||await R.setItem(e.id,await t.snapshot({id:e.id})),!await k.hasItem(e.id)){const i=await t.screenshot({id:e.id});await k.setItem(e.id,i)}window.open(g.resolve({name:"snapshot",params:{snapshotId:e.id}}).href)},e=>e.id),W=[I,E,C,T,A,p,{key:"actions",title:"Action",fixed:"right",width:"120px",render(e){return n(j,{size:"small"},{default:()=>[n(y,{size:"small",loading:V.loading[e.id],onClick:()=>V.invoke(e)},{default:()=>[w("查看")]})]})}}],v=H({page:1,pageSize:50,showSizePicker:!0,pageSizes:[50,100],onChange:e=>{v.page=e},onUpdatePageSize:e=>{v.pageSize=e,v.page=1}});return M(v,D),(e,i)=>{const l=Q("RouterLink");return U(),L("div",fe,[n(s(j),null,{default:d(()=>[n(l,{to:"/"},{default:d(()=>[n(s(y),null,{default:d(()=>[w(" 首页 ")]),_:1})]),_:1}),n(s(de),null,{default:d(()=>[n(s(he),{value:s(c),"onUpdate:value":i[0]||(i[0]=f=>q(c)?c.value=f:null),placeholder:"请输入设备地址",style:{minWidth:"250px"},onKeyup:J(s(u).invoke,["enter"])},null,8,["value","onKeyup"]),n(s(y),{ghost:"",onClick:s(u).invoke,loading:s(u).loading},{default:d(()=>[w(" 连接 ")]),_:1},8,["onClick","loading"])]),_:1}),a.value?(U(),L(Y,{key:0},[Z("div",ge,ee(`已连接 ${a.value.manufacturer} Android ${a.value.release}`),1),n(s(y),{ghost:"",onClick:s(o).invoke,loading:s(o).loading},{default:d(()=>[w(" 快照 ")]),_:1},8,["onClick","loading"]),n(s(y),{ghost:"",onClick:s(x).invoke,loading:s(x).loading},{default:d(()=>[w(" 下载设备所有快照 ")]),_:1},8,["onClick","loading"])],64)):ae("",!0)]),_:1}),n(s(ue),{striped:"",flexHeight:"",data:m.value,columns:W,pagination:s(v),"onUpdate:sorter":K,size:"small",class:"flex-1",scrollX:1200},null,8,["data","pagination"])])}}});export{Ce as default};
//# sourceMappingURL=DevicePage-323701a7.js.map
