import{s as z,d as O,N as $,C as G,w as H,a as M,b as Q,O as X,e as j,f as n,g as d,u as s,j as y,o as L,P as q,i as J,F as Y,h as Z,t as ee,k as ae}from"./index-871368d0.js";import{S as se,P as h,R as te,a as I,Q as k,W as ne,b as C}from"./storage-558d7cbf.js";import{t as oe}from"./check-44032eaf.js";import{u as ie,b as re,a as le}from"./index-d06f9a08.js";import{u as ce,N as ue}from"./table-99fad582.js";import{u as P,p as pe,c as T,a as de,N as he}from"./task-dbb5f90a.js";const me=B=>{const g=z(B),S=async(a,u={})=>{var v;if(!g.value)throw new Error("origin must exist");const m=new URL("/api/"+a,g.value);Object.entries(u).forEach(([p,x])=>{x!==void 0&&m.searchParams.set(p,String(x))});const o=await se(m).catch(p=>{throw h.error("网络错误:/"+a),p});if(!o.ok)throw h.error("接口错误:/"+a+":"+o.status),o;if((v=o.headers.get("Content-Type"))!=null&&v.includes("application/json")){const p=await o.clone().json();if(p.__error)throw h.error(p.message),o}return o},t=async(...a)=>await(await S(...a)).json(),_=async(...a)=>await(await S(...a)).arrayBuffer();return{origin:g,api:{device:async()=>t("device"),snapshot:async a=>t("snapshot",a),screenshot:async a=>_("screenshot",a),captureSnapshot:async()=>t("captureSnapshot"),snapshots:async()=>t("snapshots")}}},fe={flex:"","flex-col":"","p-10px":"","gap-10px":"","h-full":""},ge={class:"h-full",flex:"","flex-items-center":""},_e=O({__name:"DevicePage",setup(B){const g=$(),S=ie("新设备"),{api:t,origin:_}=me(),c=re("device_link",""),a=z(),u=P(async()=>{c.value&&(_.value=le(()=>new URL(c.value.trim()),()=>"非法设备地址").origin,c.value=_.value,a.value=await t.device())});G(async()=>{await te(500),oe(c.value)&&u.invoke()});const m=z([]);H(async()=>{if(!a.value)return;S.value="已连接 "+a.value.manufacturer;const e=await t.snapshots();e.sort((i,l)=>l.id-i.id),m.value=e});const o=P(async()=>{const e=await t.snapshot(),i=await t.screenshot({id:e.id});h.success("抓取快照成功"),await I.setItem(e.id,e),await k.setItem(e.id,i),h.success("保存快照成功");const l=await t.snapshots();l.sort((f,R)=>R.id-f.id),m.value=l}),v=P(async()=>{const e=(await t.snapshots()).map(r=>r.id),i=new Set((await k.keys()).map(r=>parseInt(r))),l=e.filter(r=>!i.has(r));if(l.length==0){h.success("没有新记录可导入");return}let f=0;const R=ne(3);await Promise.all(l.map(r=>R(async()=>{const[b,F]=await Promise.all([t.snapshot({id:r}),t.screenshot({id:r})]);b.nodes&&(await Promise.all([I.setItem(r,b),k.setItem(r,F)]),f++)}))),h.success(`导入${f}条新记录`)}),{activityIdCol:p,appIdCol:x,appNameCol:U,ctimeCol:N,appVersionCodeCol:E,appVersionNameCol:A,reseColWidth:D}=ce(),K=e=>{e.columnKey==N.key&&(N.sortOrder=e.order)},V=pe(async e=>{if(await I.hasItem(e.id)||await I.setItem(e.id,await t.snapshot({id:e.id})),!await k.hasItem(e.id)){const i=await t.screenshot({id:e.id});await k.setItem(e.id,i)}window.open(g.resolve({name:"snapshot",params:{snapshotId:e.id}}).href)},e=>e.id),W=[N,U,x,E,A,p,{key:"actions",title:"Action",fixed:"right",width:"120px",render(e){return n(T,{size:"small"},{default:()=>[n(C,{size:"small",loading:V.loading[e.id],onClick:()=>V.invoke(e)},{default:()=>[y("查看")]})]})}}],w=M({page:1,pageSize:50,showSizePicker:!0,pageSizes:[50,100],onChange:e=>{w.page=e},onUpdatePageSize:e=>{w.pageSize=e,w.page=1}});return Q(w,D),(e,i)=>{const l=X("RouterLink");return L(),j("div",fe,[n(s(T),null,{default:d(()=>[n(l,{to:"/"},{default:d(()=>[n(s(C),null,{default:d(()=>[y(" 首页 ")]),_:1})]),_:1}),n(s(de),null,{default:d(()=>[n(s(he),{value:s(c),"onUpdate:value":i[0]||(i[0]=f=>q(c)?c.value=f:null),placeholder:"请输入设备地址",style:{minWidth:"250px"},onKeyup:J(s(u).invoke,["enter"])},null,8,["value","onKeyup"]),n(s(C),{ghost:"",onClick:s(u).invoke,loading:s(u).loading},{default:d(()=>[y(" 连接 ")]),_:1},8,["onClick","loading"])]),_:1}),a.value?(L(),j(Y,{key:0},[Z("div",ge,ee(`已连接 ${a.value.manufacturer} Android ${a.value.release}`),1),n(s(C),{ghost:"",onClick:s(o).invoke,loading:s(o).loading},{default:d(()=>[y(" 快照 ")]),_:1},8,["onClick","loading"]),n(s(C),{ghost:"",onClick:s(v).invoke,loading:s(v).loading},{default:d(()=>[y(" 下载设备所有快照 ")]),_:1},8,["onClick","loading"])],64)):ae("",!0)]),_:1}),n(s(ue),{striped:"",flexHeight:"",data:m.value,columns:W,pagination:s(w),"onUpdate:sorter":K,size:"small",class:"flex-1",scrollX:1200},null,8,["data","pagination"])])}}});export{_e as default};
//# sourceMappingURL=DevicePage-a047cd94.js.map
